<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình quản lý AI Thông minh</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Variables for Professional Theming --- */
        :root {
            --bg-color: #f7f8fa;
            --container-bg: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --header-color: #2d3748;
            --border-color: #e2e8f0;
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --warning-color: #f59e0b;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --modal-bg: rgba(10, 10, 10, 0.4);
        }

        body.dark-mode {
            --bg-color: #1a202c;
            --container-bg: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --header-color: #cbd5e0;
            --border-color: #4a5568;
            --primary-color: #60a5fa;
            --primary-hover: #3b82f6;
            --danger-color: #f87171;
            --danger-hover: #ef4444;
            --warning-color: #fbbf24;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --modal-bg: rgba(0, 0, 0, 0.7);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- General Styling --- */
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-primary);
            margin: 0; 
            padding: 20px; 
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container { 
            max-width: 900px; 
            margin: 40px auto; 
            padding: 32px; 
            background: var(--container-bg); 
            border-radius: 16px; 
            box-shadow: 0 10px 25px -5px var(--shadow-color), 0 10px 10px -5px var(--shadow-color);
            transition: background-color 0.3s ease; 
        }
        
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
        h1 { color: var(--header-color); font-size: 28px; text-align: left; margin: 0; font-weight: 700; }
        
        #theme-toggle-btn {
            background-color: transparent; border: 1px solid var(--border-color); color: var(--text-secondary);
            font-size: 20px; width: 44px; height: 44px; border-radius: 50%;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: all 0.3s ease;
        }
        #theme-toggle-btn:hover { background-color: var(--bg-color); color: var(--text-primary); transform: rotate(15deg) scale(1.1); }

        #ai-form { display: flex; flex-direction: column; gap: 16px; margin-bottom: 32px; }
        .form-control, .btn { padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; font-family: 'Inter', sans-serif; width: 100%; box-sizing: border-box; background-color: var(--bg-color); color: var(--text-primary); transition: all 0.2s ease; }
        .form-control::placeholder { color: var(--text-secondary); }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-color_alpha, rgba(59, 130, 246, 0.3)); }
        .url-input-group { display: flex; gap: 8px; align-items: center; }
        #gemini-fill-btn {
            flex-shrink: 0; width: 44px; height: 44px; padding: 0; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
        }
        .loader {
            width: 18px; height: 18px; border: 2px solid currentColor;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: spin 1s linear infinite;
        }

        .btn { cursor: pointer; font-weight: 600; }
        .btn-primary { background-color: var(--primary-color); color: white; border: none; }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-danger { background-color: var(--danger-color); color: white; border: none; }
        .btn-danger:hover { background-color: var(--danger-hover); }
        
        /* --- Grid Layout for AI List --- */
        #ai-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            list-style-type: none; 
            padding: 0;
        }
        .ai-card { 
            background: var(--container-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            display: flex; flex-direction: column;
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-out;
            overflow: hidden;
        }
        .ai-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px -5px var(--shadow-color); border-color: var(--primary-color); }
        
        .card-header { padding: 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border-color); }
        .card-favicon { width: 32px; height: 32px; border-radius: 6px; background-color: var(--bg-color); object-fit: contain; }
        .card-name { font-weight: 600; font-size: 16px; color: var(--text-primary); text-decoration: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-name:hover { color: var(--primary-color); }
        
        .card-body { padding: 16px; flex-grow: 1; }
        .card-description { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }

        .card-footer { padding: 8px 16px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px; }
        .icon-btn { background: transparent; border: none; cursor: pointer; padding: 6px; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .icon-btn:hover { color: var(--text-primary); background-color: var(--border-color); }
        .icon-btn svg { width: 20px; height: 20px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s ease; }
        .modal-content { background: var(--container-bg); padding: 32px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .modal-content h2 { margin-top: 0; color: var(--header-color); }
        .modal-content p { margin: 16px 0; color: var(--text-secondary); }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; justify-content: center; }
        .btn-secondary { background-color: var(--border-color); color: var(--text-primary); border: none; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-container">
            <h1>Trình quản lý AI</h1>
            <button id="theme-toggle-btn" title="Chuyển đổi giao diện">🌙</button>
        </div>
        
        <form id="ai-form">
            <input type="text" id="ai-name" class="form-control" placeholder="Tên trang web" required>
            <div class="url-input-group">
                <input type="url" id="ai-url" class="form-control" placeholder="Dán đường dẫn (URL) vào đây" required>
                <button type="button" id="gemini-fill-btn" class="btn btn-primary" title="Gợi ý tự động với Gemini">🪄</button>
            </div>
            <input type="text" id="ai-description" class="form-control" placeholder="Mô tả ngắn" required>
            <button type="submit" class="btn btn-primary">Thêm Website</button>
        </form>

        <div id="ai-list">
            <!-- Các thẻ AI từ Firebase sẽ được hiển thị ở đây -->
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Chỉnh sửa Website</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <p><input type="text" id="edit-name" class="form-control" required></p>
                <p><input type="url" id="edit-url" class="form-control" required></p>
                <p><input type="text" id="edit-description" class="form-control" required></p>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    <button type="button" id="cancel-edit" class="btn btn-secondary">Hủy</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Xác nhận Xóa</h2>
            <p>Bạn có chắc chắn muốn xóa trang web này không? Hành động này không thể hoàn tác.</p>
            <div class="modal-actions">
                <button id="confirm-delete-btn" class="btn btn-danger">Xóa</button>
                <button id="cancel-delete-btn" class="btn btn-secondary">Hủy</button>
            </div>
        </div>
    </div>


    <!-- Import Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

    <script>
    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDYbLGwagXhh2GF7cIwq1QuJ_sktQAc4RM",
      authDomain: "my-ai-manager.firebaseapp.com",
      projectId: "my-ai-manager",
      storageBucket: "my-ai-manager.appspot.com",
      messagingSenderId: "895137521835",
      appId: "1:895137521835:web:e67a4700bb372c0a75d7ee",
      measurementId: "G-SVWQ78ZEEP"
    };

    // --- Firebase Initialization ---
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const websitesCollection = db.collection('websites');

    // --- Element References ---
    const aiForm = document.getElementById('ai-form');
    const aiNameInput = document.getElementById('ai-name');
    const aiUrlInput = document.getElementById('ai-url');
    const aiDescriptionInput = document.getElementById('ai-description');
    const aiList = document.getElementById('ai-list');
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const deleteModal = document.getElementById('delete-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const geminiFillBtn = document.getElementById('gemini-fill-btn');

    let idToDelete = null; // Variable to store the ID of the item to be deleted

    // --- Theme Toggling Logic ---
    const setTheme = (theme) => {
        document.body.classList.toggle('dark-mode', theme === 'dark');
        themeToggleBtn.innerHTML = theme === 'dark' ? '☀️' : '🌙';
        localStorage.setItem('theme', theme);
    };
    themeToggleBtn.addEventListener('click', () => setTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark'));

    // --- Gemini API Logic ---
    geminiFillBtn.addEventListener('click', async () => {
        const url = aiUrlInput.value.trim();
        if (!url) {
            alert('Vui lòng nhập đường dẫn URL trước.');
            return;
        }
        geminiFillBtn.disabled = true;
        geminiFillBtn.innerHTML = `<div class="loader"></div>`;
        const prompt = `Dựa vào URL sau: "${url}", hãy đề xuất tên và mô tả ngắn gọn cho công cụ AI này. Trả về kết quả dưới dạng một đối tượng JSON hợp lệ với các khóa là "name" và "description". Ví dụ: {"name": "Tên Công Cụ", "description": "Đây là mô tả."}`;
        try {
            const apiKey = ""; // Canvas will provide the API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Lỗi API: ${response.statusText}`);
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                const data = JSON.parse(text);
                aiNameInput.value = data.name || '';
                aiDescriptionInput.value = data.description || '';
            } else { throw new Error('Không nhận được phản hồi hợp lệ từ Gemini.'); }
        } catch (error) {
            console.error('Lỗi khi gọi Gemini API:', error);
            alert('Đã có lỗi xảy ra khi cố gắng gợi ý thông tin. Vui lòng thử lại.');
        } finally {
            geminiFillBtn.disabled = false;
            geminiFillBtn.innerHTML = '🪄';
        }
    });

    // --- Real-time Data Listener ---
    websitesCollection.orderBy('name').onSnapshot(snapshot => {
        const websites = [];
        snapshot.forEach(doc => {
            websites.push({ ...doc.data(), id: doc.id });
        });
        renderWebsites(websites);
    });

    const renderWebsites = (websites) => {
        aiList.innerHTML = '';
        websites.forEach(site => {
            const card = document.createElement('div');
            card.className = 'ai-card';
            const faviconUrl = `https://www.google.com/s2/favicons?sz=64&domain_url=${site.url}`;
            card.innerHTML = `
                <div class="card-header">
                    <img src="${faviconUrl}" alt="Favicon" class="card-favicon" onerror="this.src='https://placehold.co/64x64/f0f2f5/a0aec0?text=AI'">
                    <a href="${site.url}" target="_blank" class="card-name" title="${site.name}">${site.name}</a>
                </div>
                <div class="card-body">
                    <p class="card-description">${site.description}</p>
                </div>
                <div class="card-footer">
                    <button class="icon-btn btn-edit" data-id="${site.id}" title="Sửa">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                    </button>
                    <button class="icon-btn btn-delete" data-id="${site.id}" title="Xóa">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                    </button>
                </div>
            `;
            aiList.appendChild(card);
        });
    };

    // --- CRUD Operations ---
    aiForm.addEventListener('submit', e => {
        e.preventDefault();
        websitesCollection.add({ 
            name: aiNameInput.value.trim(), 
            url: aiUrlInput.value.trim(), 
            description: aiDescriptionInput.value.trim() 
        });
        aiForm.reset();
    });

    aiList.addEventListener('click', e => {
        const button = e.target.closest('.icon-btn');
        if (!button) return;
        const id = button.dataset.id;
        if (!id) return;

        if (button.classList.contains('btn-delete')) {
            idToDelete = id;
            deleteModal.style.display = 'flex';
        }
        if (button.classList.contains('btn-edit')) {
            websitesCollection.doc(id).get().then(doc => {
                if (!doc.exists) return;
                const site = doc.data();
                document.getElementById('edit-id').value = doc.id;
                document.getElementById('edit-name').value = site.name;
                document.getElementById('edit-url').value = site.url;
                document.getElementById('edit-description').value = site.description;
                editModal.style.display = 'flex';
            });
        }
    });
    
    // --- Modal Logic ---
    const closeAllModals = () => {
        editModal.style.display = 'none';
        deleteModal.style.display = 'none';
    };

    editForm.addEventListener('submit', e => {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const updatedData = {
            name: document.getElementById('edit-name').value.trim(),
            url: document.getElementById('edit-url').value.trim(),
            description: document.getElementById('edit-description').value.trim()
        };
        websitesCollection.doc(id).update(updatedData);
        closeAllModals();
    });
    
    confirmDeleteBtn.addEventListener('click', () => {
        if (idToDelete) {
            websitesCollection.doc(idToDelete).delete();
        }
        closeAllModals();
    });

    cancelEditBtn.addEventListener('click', closeAllModals);
    cancelDeleteBtn.addEventListener('click', closeAllModals);
    
    // --- Initial Load ---
    setTheme(localStorage.getItem('theme') || 'light');

    </script>
</body>
</html>
